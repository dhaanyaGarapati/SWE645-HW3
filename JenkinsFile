// SWE645 HW3 - CI/CD pipeline
// Builds & pushes backend + frontend images and deploys to GKE

// Lasya Reddy Mekala (G01473683)
// Supraja Naraharisetty(G01507868)
// Trinaya Kodavati (G01506073)
// Dhaanya S Garapati (G01512900)

pipeline {
  agent any

  triggers {
    githubPush()
  }

  environment {
    // GCP / GKE
    PROJECT   = 'swe645hw3-478221'
    LOCATION  = 'us-central1'
    LOC_FLAG  = '--region'
    CLUSTER   = 'survey-cluster'

    // K8s
    NAMESPACE       = 'survey-app'
    BACKEND_DEPLOY  = 'survey-backend'   // deployment.metadata.name in k8s-backend.yaml
    FRONTEND_DEPLOY = 'survey-frontend'  // deployment.metadata.name in k8s-frontend.yaml

    // Docker Hub images
    BACKEND_IMAGE   = 'dgarapati03/survey-backend'
    FRONTEND_IMAGE  = 'dgarapati03/survey-frontend'
    TAG             = "${env.BUILD_NUMBER}"
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
        sh 'ls -la'
      }
    }

    stage('Build Docker images') {
      steps {
        sh '''
          set -eu
          echo "Building BACKEND image: ${BACKEND_IMAGE}:${TAG}"
          docker build -t ${BACKEND_IMAGE}:${TAG} backend

          echo "Building FRONTEND image: ${FRONTEND_IMAGE}:${TAG}"
          docker build -t ${FRONTEND_IMAGE}:${TAG} frontend-react
        '''
      }
    }

    stage('Push to Docker Hub') {
      steps {
        withCredentials([
          usernamePassword(
            credentialsId: 'dockerhub',   // Jenkins cred for Docker Hub
            usernameVariable: 'U',
            passwordVariable: 'TOKEN'
          )
        ]) {
          sh '''
            set -eu
            echo "$TOKEN" | docker login -u "$U" --password-stdin

            docker push ${BACKEND_IMAGE}:${TAG}
            docker push ${FRONTEND_IMAGE}:${TAG}

            docker logout
          '''
        }
      }
    }

    stage('GCP auth & connect to GKE') {
      steps {
        withCredentials([
          file(credentialsId: 'gcp-key', variable: 'GOOGLE_APPLICATION_CREDENTIALS')
        ]) {
          sh '''
            set -eu
            gcloud auth activate-service-account --key-file="$GOOGLE_APPLICATION_CREDENTIALS"
            gcloud config set project ${PROJECT}
            gcloud container clusters get-credentials ${CLUSTER} ${LOC_FLAG} ${LOCATION} --project ${PROJECT}
          '''
        }
      }
    }

    stage('Deploy to Kubernetes (3 replicas)') {
      steps {
        sh '''
          set -eu

          echo "Ensuring namespace exists..."
          kubectl create namespace ${NAMESPACE} --dry-run=client -o yaml | kubectl apply -f -

          echo "Applying backend & frontend manifests..."
          kubectl -n ${NAMESPACE} apply -f k8s-backend.yaml
          kubectl -n ${NAMESPACE} apply -f k8s-frontend.yaml

          echo "Updating deployment images to current build tag..."
          kubectl -n ${NAMESPACE} set image deploy/${BACKEND_DEPLOY} "*=${BACKEND_IMAGE}:${TAG}"
          kubectl -n ${NAMESPACE} set image deploy/${FRONTEND_DEPLOY} "*=${FRONTEND_IMAGE}:${TAG}"

          echo "Scaling deployments to 3 replicas..."
          kubectl -n ${NAMESPACE} scale deploy/${BACKEND_DEPLOY} --replicas=3 || true
          kubectl -n ${NAMESPACE} scale deploy/${FRONTEND_DEPLOY} --replicas=3 || true

          echo "Waiting for rollout (non-fatal if timeout)..."
          kubectl -n ${NAMESPACE} rollout status deploy/${BACKEND_DEPLOY} --timeout=60s || true
          kubectl -n ${NAMESPACE} rollout status deploy/${FRONTEND_DEPLOY} --timeout=60s || true

          echo "----- Pods -----"
          kubectl -n ${NAMESPACE} get pods -o wide || true

          echo "----- Services -----"
          kubectl -n ${NAMESPACE} get svc -o wide || true
        '''
      }
    }
  }

  post {
    success {
      echo "Deployed backend=${BACKEND_IMAGE}:${TAG}, frontend=${FRONTEND_IMAGE}:${TAG} to namespace ${NAMESPACE}"
    }
    failure {
      echo "Build/Deploy failed â€” check the failing stage logs above."
    }
  }
}
