// SWE645 HW3 - CI/CD pipeline (no GKE, just Docker build+push)

pipeline {
  agent any

  triggers {
    githubPush()
  }

  environment {
    IMAGE = 'dgarapati03/survey-frontend'
    TAG   = "${env.BUILD_NUMBER}"
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
        sh 'ls -la'
      }
    }

    stage('Build Docker image') {
      steps {
        sh '''
          set -eu
          echo "Building image: ${IMAGE}:${TAG}"
          docker build -t ${IMAGE}:${TAG} .
        '''
      }
    }

    stage('Push to Docker Hub') {
      steps {
        withCredentials([usernamePassword(
          credentialsId: 'dockerhub',
          usernameVariable: 'U',
          passwordVariable: 'TOKEN'
        )]) {
          sh '''
            set -eu
            echo "$TOKEN" | docker login -u "$U" --password-stdin
            docker push ${IMAGE}:${TAG}
            docker logout
          '''
        }
      }
    }
  }

  post {
    success {
      echo "Built and pushed ${IMAGE}:${TAG} to Docker Hub"
    }
    failure {
      echo "Build/Push failed â€” check the failing stage logs above."
    }
  }
}
