// SWE645 HW3 - CI/CD pipeline
// Uses Docker Hub account: dgarapati03

pipeline {
  agent any

  // Trigger via GitHub webhooks (job config may also have Poll SCM)
  triggers {
    githubPush()
  }

  environment {
    // GKE / GCP details for HW3
    PROJECT   = 'swe645hw3-478221'
    LOCATION  = 'us-central1'      // region
    LOC_FLAG  = '--region'         // use --region for regional clusters
    CLUSTER   = 'survey-cluster'

    // Kubernetes app details
    NAMESPACE = 'survey-app'
    DEPLOY    = 'survey-frontend'  // deployment.metadata.name in your YAML

    // Docker Hub image (owner: dgarapati03)
    IMAGE     = 'dgarapati03/survey-frontend'
    TAG       = "${env.BUILD_NUMBER}"
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
        sh 'ls -la'
      }
    }

    stage('Build Docker image') {
      steps {
        sh '''
          set -eu
          echo "Building image: ${IMAGE}:${TAG}"
          docker build -t ${IMAGE}:${TAG} .
        '''
      }
    }

    stage('Push to Docker Hub') {
      steps {
        withCredentials([
          usernamePassword(
            credentialsId: 'dockerhub',   // Jenkins credential for Docker Hub
            usernameVariable: 'U',
            passwordVariable: 'TOKEN'
          )
        ]) {
          sh '''
            set -eu
            echo "$TOKEN" | docker login -u "$U" --password-stdin
            docker push ${IMAGE}:${TAG}
            docker logout
          '''
        }
      }
    }

    stage('GCP auth & connect to GKE') {
      steps {
        withCredentials([
          file(credentialsId: 'gcp-key', variable: 'GOOGLE_APPLICATION_CREDENTIALS')
        ]) {
          sh '''
            set -eu
            gcloud --version
            gcloud auth activate-service-account --key-file="$GOOGLE_APPLICATION_CREDENTIALS"
            gcloud config set project ${PROJECT}
            gcloud container clusters get-credentials ${CLUSTER} ${LOC_FLAG} ${LOCATION} --project ${PROJECT}
            kubectl version --client=true
          '''
        }
      }
    }

    stage('Deploy to Kubernetes (3 replicas)') {
      steps {
        sh '''
          set -eu

          echo "Ensuring namespace exists..."
          kubectl create namespace ${NAMESPACE} --dry-run=client -o yaml | kubectl apply -f -

          echo "Applying backend & frontend manifests..."
          kubectl -n ${NAMESPACE} apply -f k8s-backend.yaml
          kubectl -n ${NAMESPACE} apply -f k8s-frontend.yaml

          echo "Force-deleting existing frontend pods (if any) to avoid stuck old replicas..."
          kubectl -n ${NAMESPACE} delete pods -l app=${DEPLOY} --force --grace-period=0 || true

          echo "Updating deployment image to: ${IMAGE}:${TAG}"
          kubectl -n ${NAMESPACE} set image deploy/${DEPLOY} ${DEPLOY}=${IMAGE}:${TAG} \
            || kubectl -n ${NAMESPACE} set image deploy/${DEPLOY} web=${IMAGE}:${TAG}

          echo "Scaling deployment to 3 replicas..."
          kubectl -n ${NAMESPACE} scale deploy/${DEPLOY} --replicas=3 || true

          echo "Waiting for rollout (non-fatal if it times out)..."
          if ! kubectl -n ${NAMESPACE} rollout status deploy/${DEPLOY} --timeout=180s; then
            echo "WARNING: rollout did not finish in time. Check pods manually with:"
            echo "  kubectl -n ${NAMESPACE} get pods -o wide"
          fi

          echo "----- Current Pods -----"
          kubectl -n ${NAMESPACE} get pods -o wide || true

          echo "----- Current Services -----"
          kubectl -n ${NAMESPACE} get svc -o wide || true
        '''
      }
    }
  }

  post {
    success {
      echo "Deployed ${IMAGE}:${TAG} to namespace ${NAMESPACE}"
    }
    failure {
      echo "Build/Deploy failed â€” check the failing stage logs above."
    }
  }
}
